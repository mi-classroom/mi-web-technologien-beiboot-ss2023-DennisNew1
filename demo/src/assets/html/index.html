<!DOCTYPE html>
<html>
<!-- aframe as 3D Library-->
<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
<!-- arjs version with marker and location support -->
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

<style>
    .loading-screen {
        position: absolute;
        bottom: 0;
        left: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        background-color: rgba(0, 0, 0, 100%);
        height: 100vh;
        width: 100vw;
    }

    .btn {
        width: 10em;
        height: 5em;
    }

    .hide {
        display: none;
        cursor: default;
    }

    .switch-btn {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 10;
    }
</style>

<script>
    var isVideoPlaying = false;
    var isStartButtonClicked = false;
    var isGalleryMode = false;
    var imageNr = 0;
    // amount of images in gallery. 
    var maxImages = 4;

    initVideo();
    initGallery();

    function initVideo() {
        console.log("init video");
        // Controls video play/pause interaction
        AFRAME.registerComponent('videohandler', {
            init: function() {
                console.log("added click listener");
                this.el.addEventListener("click", function(e) {
                    console.log(e);
                    // prevent from starting too early.
                    if (isStartButtonClicked && document.querySelector("#marker").object3D.visible) {
                        let video = document.querySelector("#video-asset");
                        if (!isVideoPlaying) {
                            console.log("play");
                            video.play();
                            isVideoPlaying = true;
                        } else {
                            console.log("pause");
                            video.pause();
                            isVideoPlaying = false;
                        }
                    }
                });
            } 
        });       
    }
    // initGallery eventlistener
    function initGallery() {
        AFRAME.registerComponent('galleryhandler', {
            init: function() {
                console.log("added click listener");
                this.el.addEventListener("click", function(e) {
                    console.log("imagenr " + imageNr);
                    console.log("max" + maxImages);
                    if (e.target.id === "next-btn") {
                        imageNr = imageNr < (maxImages - 1) ? (imageNr+1) : 0;
                    } else {
                        imageNr = imageNr > 0 ? (imageNr-1) : 3;
                    }
                    document.querySelector("#image").setAttribute("src", `#church${imageNr}`);
                    console.log("showing church" + imageNr);
                });
            } 
        });   
    }

    function start(e) {
        e.parentElement.classList.add("hide");
        isStartButtonClicked = true;
        document.querySelector("#switch").classList.remove("hide");
    }

    function onClickSwitch() {
        if (!isGalleryMode) {
            deleteVideoPlayer();
            createGallery();
            
        } else {
            deleteGallery();
            createVideoPlayer();          
        }   
        isGalleryMode = !isGalleryMode; 
        console.log("is gallery mode after:" + isGalleryMode);
    }

    function createGallery() {
        const parent = document.querySelector("#marker");
        // add photo
        let gallery = document.createElement("a-image");
        gallery.setAttribute("src", `#church${imageNr}`);
        gallery.setAttribute("rotation", "-90 0 0");
        gallery.id = "image";
        parent.appendChild(gallery);
        //set up gallery controls
        parent.appendChild(create3DTextElement("previous-btn", "<", "-0.75 0 0"));
        parent.appendChild(create3DTextElement("next-btn", ">", "0.75 0 0"));
    }

    function deleteGallery() {
        let image = document.querySelector("#image")
        let parent = image.parentNode;
        removeAllChilds(parent);
    }

    function createVideoPlayer() {
        const parent = document.querySelector("#marker");
        let video = document.createElement("a-video");
        video.setAttribute("rotation", "-90 0 0");
        video.id = "video";
        video.setAttribute("src", "#video-asset");
        video.setAttribute("videohandler", "");
        video.setAttribute("width", "1.2");
        video.setAttribute("height", "0.6");
        parent.appendChild(video);
    }

    function deleteVideoPlayer() {
        let video = document.querySelector("#video")
        let parent = video.parentNode;
        parent.removeChild(video);
    }

    function create3DTextElement(id, text, pos ) {
        let el = document.createElement("a-text");
        el.id = id;
        el.setAttribute("value", text);
        el.setAttribute("color", "black");
        el.setAttribute("align", "center");
        el.setAttribute("geometry", "primitive:plane; width: 0.5: height: 0.5");
        el.setAttribute("material", "opacity: 0.0; transparent: true");
        el.setAttribute("position", pos);
        el.setAttribute("galleryhandler", "");
        el.setAttribute("rotation", "-90 0 0");
        return el;
    }

    function removeAllChilds(el) {
        while (el.firstChild) {
            el.removeChild(el.firstChild);
        }
    }
</script>

<body style="margin : 0px; overflow: hidden;">
    <!--script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();    
    </script!-->
    <div class="loading-screen">
        <button id="start" class="btn" onclick="start(this)">Start</button>
    </div>
    <button id="switch" class="switch-btn hide" onclick="onClickSwitch()">Switch mode</button>
    <a-scene embedded arjs>
        <a-assets>
            <!-- Works only in Chrome so far-->
            <video id="video-asset" loop="true" src="church.mp4" autoplay="false"></video>
            <img id="church0" src="./images/church0.jpg">
            <img id="church1" src="./images/church1.jpg">
            <img id="church2" src="./images/church2.jpg">
            <img id="church3" src="./images//church3.jpg">
        </a-assets>
        <!-- Using the preset hiro marker, can be found here: https://commons.wikimedia.org/wiki/File:Hiro_marker_ARjs.png-->
        <a-entity cursor="rayOrigin:mouse"></a-entity>
        <a-marker id="marker" preset="hiro">
            <!-- video rotated by -90 degrees, so it showing acurately on a flat surface -->
            <a-video class="collidable"  id="video" src="#video-asset" rotation="-90 0 0" width="1.2" height="0.6" videohandler>
            </a-video>
        </a-marker>
        <!-- https://github.com/AR-js-org/AR.js/issues/40 or https://github.com/AR-js-org/AR.js/issues/493 cursor is still off sometimes 
        work around with fov-->
        <a-entity  camera="fov: 45">   
        </a-entity>

    </a-scene>
    
</body>

</html>